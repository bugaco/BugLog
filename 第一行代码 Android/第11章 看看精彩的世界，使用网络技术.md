## 11.1 WebViewçš„ç”¨æ³•

```kotlin
webView.settings.javaScriptEnabled = true // å¯ç”¨js
webView.webViewClient = WebViewClient() // éœ€è¦è·³è½¬ç½‘é¡µæ—¶ï¼Œåœ¨å½“å‰WebViewå±•ç¤ºï¼Œä¸æ‰“å¼€ç³»ç»Ÿæµè§ˆå™¨
webView.loadUrl("https://www.baidu.com")
```

## 12.2

å¸ƒå±€æ–‡ä»¶ï¼šä¸€ä¸ªButtonï¼Œä¸€ä¸ªScrollView

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical">

    <Button
        android:id="@+id/sendRequestBtn"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Send Request" />

    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="match_parent">

        <TextView
            android:id="@+id/responseText"
            android:layout_width="match_parent"
            android:layout_height="wrap_content" />
    </ScrollView>
</LinearLayout>
```

ç‚¹å‡»æŒ‰é’®åï¼Œè¿›è¡Œç½‘ç»œè¯·æ±‚åŠ è½½å†…å®¹ï¼š

```kotlin
class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        ...
        sendRequestBtn.setOnClickListener {
            sendRequestWithHttpURLConnection()
        }
    }

    private fun sendRequestWithHttpURLConnection() {
        // å¼€å¯çº¿ç¨‹å‘èµ·ç½‘ç»œè¯·æ±‚
        thread {
            var connection: HttpURLConnection? = null
            try {
                val response = StringBuilder()
                val url = URL("https://www.v2ex.com")
                connection = url.openConnection() as HttpURLConnection
                connection.requestMethod = "GET"
                connection.connectTimeout = 8000
                connection.readTimeout = 8000
                val input = connection.inputStream
                // å¯¹è·å–åˆ°çš„æ•°æ®æµè¿›è¡Œè¯»å–
                val reader = BufferedReader(InputStreamReader(input))
                reader.use {
                    reader.forEachLine {
                        response.append(it)
                    }
                }
                showResponse(response.toString())
            } catch (e: Exception) {
                e.printStackTrace()
            } finally {
                connection?.disconnect()
            }
        }
    }

    private fun showResponse(response: String) {
        runOnUiThread {
            // åœ¨è¿™é‡Œè¿›è¡ŒUIæ“ä½œï¼Œå°†ç»“æœæ˜¾ç¤ºåˆ°ç•Œé¢ä¸Š
            responseText.text = response
        }
    }
}
```

æ•ˆæœå›¾ï¼š

![image-20200422102814340](https://tva1.sinaimg.cn/large/007S8ZIlly1ge2c4x4c4jj30ap0j3djo.jpg)

å¦‚æœè¦æäº¤æ•°æ®ç»™æœåŠ¡å™¨çš„è¯ï¼Œå¯ä»¥è¿™æ ·ï¼š

```kotlin
/* ç»™æœåŠ¡å™¨ä¼ å‚ */
connection.requestMethod = "POST"
val output = DataOutputStream(connection.outputStream)
output.writeBytes("username=admin&password=123456")
```

### 11.2.2 ä½¿ç”¨OkHttp

åœ¨ app/build.gradle ä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
dependencies {
    ...
    implementation("com.squareup.okhttp3:okhttp:4.5.0")
    ...
}
```

ç„¶å

```kotlin
private fun sendRequestWithOkHttp() {
    thread {
        try {
            val client = OkHttpClient()
            val request = Request.Builder()
                .url("https://www.v2ex.com")
                .build()
            val response = client.newCall(request).execute()
            val responseData = response.body?.string()
            if (responseData != null) {
                showResponse(responseData)
            }
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
}
```

postæ–¹æ³•çš„è¯ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª`FormBody`ï¼Œç„¶åå°†è¿™ä¸ªå‚æ•°åŠ å…¥`Request`ä¸­

```kotlin
private fun sendRequestWithOkHttpByPost() {
    				...
            val requestBody = FormBody.Builder()
                .add("username", "admin")
                .add("password", "123456")
                .build()
            val request = Request.Builder()
                .url("https://www.v2ex.com")
                .post(requestBody)
                .build()
            ...
}
```



## 11.3 è§£æXMLæ ¼å¼æ•°æ®

### 11.3.0 é…ç½®apacheæœåŠ¡ï¼ˆmacOSï¼‰

åœ¨`/Library/WebServer/Documents`ç›®å½•ä¸‹ï¼Œæ”¾ç½®ä¸€ä¸ªxmlæ–‡ä»¶ï¼Œç„¶åå¯åŠ¨apache

```ruby
sudo apachectl start
```



xmlæ–‡ä»¶ï¼š

```xml
<apps>
    
    <app>
        <id>1</id>
        <name>Chrome</name>
        <version>2.1</version>
    </app>
    
    <app>
        <id>2</id>
        <name>Google Maps</name>
        <version>1.0</version>
    </app>
    
    <app>
        <id>3</id>
        <name>Google Play</name>
        <version>2.3</version>
    </app>
    
</apps>
```

### 11.3.1 Pullè§£ææ–¹å¼

#### 1âƒ£ï¸é…ç½®å…è®¸httpä¼ è¾“

##### (1)æ–°å»ºé…ç½®æ–‡ä»¶

ä»å®‰å“9å¼€å§‹ï¼Œé»˜è®¤ä¸å…è®¸httpä¼ è¾“

åœ¨`res`ç›®å½•ä¸‹ï¼Œæ–°å»º`xml`ç›®å½•ï¼Œæ–°å»º`network_config.xml`æ–‡ä»¶ï¼š

![image-20200422151639329](https://tva1.sinaimg.cn/large/007S8ZIlly1ge2kh0cpavj306v04wmx5.jpg)

```xml
<?xml version="1.0" encoding="utf-8" ?>
<network-security-config>
    <base-config cleartextTrafficPermitted="true">
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </base-config>
</network-security-config>
```

##### (2)å¯ç”¨é…ç½®æ–‡ä»¶

åœ¨`AndroidManifext.xml`ä¸­æ·»åŠ é…ç½®

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    ... />
    <application
        ...
        android:networkSecurityConfig="@xml/network_config">
        ...
    </application>
</manifest>
```

#### 2âƒ£ï¸ä»£ç è§£æ

```kotlin
...
	if (responseData != null) {
                    parseXMLWithPull(responseData)
                }
...

private fun requestXMLDataWithOkHttp() {
    thread {
        try {
            val client = OkHttpClient()
            val request = Request.Builder()
                .url("http://192.168.3.11/get_data.xml")
                .build()
            val response = client.newCall(request).execute()
            val responseData = response.body?.string()
            if (responseData != null) {
                parseXMLWithPull(responseData)
            }
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
}
```

### 11.3.2 SAXè§£ææ–¹å¼

æ–°å»ºç»§æ‰¿è‡ª`DefaultHandler`çš„ç±»`ContentHandler`

```kotlin
class ContentHandler: DefaultHandler() {

    private var nodeName = ""
    private lateinit var id: StringBuilder
    private lateinit var name: StringBuilder
    private lateinit var version: StringBuilder

    override fun startElement(
        uri: String?,
        localName: String?,
        qName: String?,
        attributes: Attributes?
    ) {
        // è®°å½•å½“å‰èŠ‚ç‚¹å
        nodeName = localName.toString()

        Log.d("ContentHandler", "uri is $uri")
        Log.d("ContentHandler", "localName is $localName")
        Log.d("ContentHandler", "qName is $qName")
        Log.d("ContentHandler", "attributes is $attributes")
    }

    override fun characters(ch: CharArray?, start: Int, length: Int) {
        // æ ¹æ®å½“å‰èŠ‚ç‚¹ååˆ¤æ–­å°†å†…å®¹æ·»åŠ åˆ°å“ªä¸€ä¸ªStringBuilderå¯¹è±¡ä¸­
        when (nodeName) {
            "id" -> id.append(ch, start, length)
            "name" -> name.append(ch, start, length)
            "version" -> version.append(ch, start, length)
        }
    }

    override fun endElement(uri: String?, localName: String?, qName: String?) {
        if (localName == "app") {
            Log.d("ContentHandler", "id is ${id.toString().trim()}")
            Log.d("ContentHandler", "name is ${name.toString().trim()}")
            Log.d("ContentHandler", "version is ${version.toString().trim()}")
            // æœ€åå°†StringBuilderæ¸…ç©º
            id.setLength(0)
            name.setLength(0)
            version.setLength(0)
        }
    }

    override fun endDocument() {
        super.endDocument()
    }

    override fun startDocument() {
        super.startDocument()
        id = StringBuilder()
        name = StringBuilder()
        version = StringBuilder()
    }
}
```

ç„¶åè§£æxmlæ–‡ä»¶ï¼š

```kotlin
{
	...
	parseXMLWithSAX(responseData)
	...
}
private fun parseXMLWithSAX(xmlData: String) {
    try {
        val factory = SAXParserFactory.newInstance()
        val xmlReader = factory.newSAXParser().xmlReader
        val handler = ContentHandler()
        // å°†ContentHandlerçš„å®ä¾‹è®¾ç½®åˆ°XMLReaderä¸­
        xmlReader.contentHandler = handler
        // å¼€å§‹æ‰§è¡Œè§£æ
        xmlReader.parse(InputSource(StringReader(xmlData)))
    } catch (e: Exception) {
        e.printStackTrace()
    }
}
```



## 11.4 è§£æJSONæ ¼å¼æ•°æ®

### 11.4.1 ä½¿ç”¨JSONObject

å¯èƒ½ä¸€ç›´åœ¨è§£æjsonï¼Œè¿™ä¸ªå†™èµ·æ¥é¡ºæ‰‹äº†å¾ˆå¤šğŸ˜„

```kotlin
import okhttp3.OkHttpClient
import okhttp3.Request
import org.json.JSONArray
...
private fun requestJSONDataWithOkHttp() {
        thread {
            try {
                val client = OkHttpClient()
                val request = Request.Builder()
                        .url("http://192.168.3.11/get_data.json")
                        .build()
                val response = client.newCall(request).execute()
                val responseData = response.body?.string()
                if (responseData != null) {
                    parJSONWithJSONObject(responseData)
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }
private fun parJSONWithJSONObject(jsonData: String) {
        try {
            val jsonArray = JSONArray(jsonData)
            for (i in 0 until jsonArray.length()) {
                val jsonObject = jsonArray.getJSONObject(i)
                val id = jsonObject.getString("id")
                val name = jsonObject.getString("name")
                val version = jsonObject.getString("version")
                Log.d("MainActivity", "id is $id")
                Log.d("MainActivity", "name is $name")
                Log.d("MainActivity", "version is $version")
            }
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
...
```

### 11.4.2 ä½¿ç”¨GSON

è¿™ä¸ªå°±å¾ˆæ–¹ä¾¿äº†ï¼Œç›´æ¥æŠŠjsonè½¬æ¢ä¸ºModeläº†

```kotlin
private fun parJSONWithGson(jsonData: String) {
    try {
        val gson = Gson()
        val typeOf = object : TypeToken<List<App>>(){}.type
        val appList = gson.fromJson<List<App>>(jsonData, typeOf)
        for (app in appList) {
            Log.d("MainActivity", "id is ${app.id}")
            Log.d("MainActivity", "name is ${app.name}")
            Log.d("MainActivity", "version is ${app.version}")
        }
    } catch (e: Exception) {
        e.printStackTrace()
    }
}
```

è¾“å‡ºå¦‚ä¸‹ï¼š

![image-20200422172407247](https://tva1.sinaimg.cn/large/007S8ZIlly1ge2o5rdyo9j30ca06z3z2.jpg)



## 11.5 ç½‘ç»œè¯·æ±‚å›è°ƒçš„å®ç°æ–¹å¼



å¯ä»¥å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„æ–¹æ³•ï¼š

```kotlin
object HttpUtil {
    fun sendHttpRequest(address: String): String {
        var connection: HttpURLConnection? = null
        try {
            val response = StringBuilder()
            val url = URL(address)
            connection = url.openConnection() as HttpURLConnection
            connection.connectTimeout = 8000
            connection.readTimeout = 8000
            val input = connection.inputStream
            val reader = BufferedReader(InputStreamReader(input))
            reader.use {
                it.forEachLine {
                    response.append(it)
                }
            }
            return response.toString()
        } catch (e: Exception) {
            e.printStackTrace()
            return e.message.toString()
        } finally {
            connection?.disconnect()
        }
    }
}
```

ç„¶åè¿™æ ·è°ƒç”¨ï¼š

```kotlin
fun main() {
    val address = "https://www.v2ex.com"
    val response = HttpUtil.sendHttpRequest(address)
}
```

ä½†æ˜¯è¿™æ ·ä¼šé˜»å¡ä¸»çº¿ç¨‹

äºæ˜¯ï¼Œæˆ‘ä»¬è¿™æ ·å†™

```kotlin
object HttpUtil {
    fun sendHttpRequest(address: String, listener: HttpCallbackListener) {
        thread {
            var connection: HttpURLConnection? = null
            try {
                val response = StringBuilder()
                val url = URL(address)
                connection = url.openConnection() as HttpURLConnection
                connection.connectTimeout = 8000
                connection.readTimeout = 8000
                val input = connection.inputStream
                val reader = BufferedReader(InputStreamReader(input))
                reader.use {
                    it.forEachLine {
                        response.append(it)
                    }
                }
                listener.onFinish(response.toString())
            } catch (e: Exception) {
                e.printStackTrace()
                listener.onError(e)
            } finally {
                connection?.disconnect()
            }
        }
    }
}
```

ç„¶åè¿™æ ·è°ƒç”¨ï¼š

```kotlin
fun main() {
    val address = "https://www.v2ex.com"
    HttpUtil.sendHttpRequest(address, object : HttpCallbackListener {
        override fun onFinish(response: String) {

        }

        override fun onError(e: Exception) {

        }
    })
}
```

### 11.5.2 OkHttpçš„å›è°ƒ

å°è£…ï¼š

```kotlin
object HttpUtil {
    fun sendOkHttpRequest(address: String, callback: okhttp3.Callback) {
        val client = OkHttpClient()
        val request = Request.Builder()
            .url(address)
            .build()
        client.newCall(request).enqueue(callback)
    }
}
```

è°ƒç”¨ï¼š

```kotlin
HttpUtil.sendOkHttpRequest(address, object : okhttp3.Callback {
    override fun onFailure(call: Call, e: IOException) {
			runOnUiThread {
        
      }
    }

    override fun onResponse(call: Call, response: Response) {
        runOnUiThread {
        
      }
    }
})
```



## 11.6 æœ€å¥½ç”¨çš„ç½‘ç»œåº“ï¼šRetrofit

### 11.6.1 Retrofitçš„åŸºæœ¬ç”¨æ³•

1âƒ£ï¸åƒä¹‹å‰ä¸€æ ·ï¼Œé…ç½®å…è®¸httpè¯·æ±‚ã€æ³¨å†Œç½‘ç»œæƒé™

2âƒ£ï¸åœ¨gradleä¸­å¼•å…¥ä¾èµ–ï¼š

```
dependencies {
    implementation 'com.squareup.retrofit2:retrofit:2.6.1'
    implementation 'com.squareup.retrofit2:converter-gson:2.6.1'
}
```

3âƒ£ï¸å°†è¯·æ±‚åœ°å€ï¼Œç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªæ¥å£ä¸­ï¼š

```kotlin
import retrofit2.Call
import retrofit2.http.GET

interface AppService {
    @GET("get_data.json")
    fun getAppData(): Call<List<App>>
}
```

4âƒ£ï¸æ ¹æ®æœåŠ¡å™¨ä¸Šçš„jsonç»“æ„

æ–°å»ºModelç±»ï¼š

```kotlin
class App(val id: String, val name: String, val version: String)
```

5âƒ£ï¸è¯·æ±‚æ¥å£ä»£ç ç¼–å†™

```kotlin
getAppDataBtn.setOnClickListener {
    val retrofit = Retrofit.Builder()
        .baseUrl("http://192.168.3.11/")
        .addConverterFactory(GsonConverterFactory.create())
        .build()
    val appService = retrofit.create(AppService::class.java)
    appService.getAppData().enqueue(object : Callback<List<App>> {
        override fun onFailure(call: Call<List<App>>, t: Throwable) {
            t.printStackTrace()
        }

        override fun onResponse(call: Call<List<App>>,
                                response: Response<List<App>>) {
            val list = response.body()
            if (list != null) {
                for (app in list) {
                    Log.d("MainActivity", "id is ${app.id}")
                    Log.d("MainActivity", "name is ${app.name}")
                    Log.d("MainActivity", "version is ${app.version}")
                }
            }
        }
    })
}
```

### 11.6.2 å¤„ç†å¤æ‚çš„æ¥å£åœ°å€ç±»å‹

```kotlin
/* åŠ¨æ€è·¯å¾„ï¼šä¼ å…¥page
* å¯¹æ¯”ç¡¬ç¼–ç çš„è·¯å¾„ï¼š"1/get_data.json"ã€"2/get_data.json"
*  */
@GET("{page}/get_data.json")
fun getData(@Path("page") page: Int): Call<Data>

/* åœ¨urlè·¯å¾„ä¸­ä¼ å…¥å¤šä¸ªå‚æ•°
* å¯¹æ¯”ç¡¬ç¼–ç çš„å†™æ³•ï¼šget_data.json?u=<user>&t=<token> */
@GET("get_data.json")
fun getData(@Query("u") user: String, @Query("t") token: String): Call<Data>

/* åˆ é™¤æŒ‡å®šidçš„æ•°æ®
* ResponseBody è¡¨ç¤ºå¯¹æœåŠ¡å™¨å“åº”çš„æ•°æ®ä¸å…³å¿ƒ */
@DELETE("data/{id}")
fun deleteData(@Path("id") id: String): Call<ResponseBody>

/* ä½¿ç”¨bodyä¼ å‚æ•° */
@POST("data/create")
fun createData(@Body data: Data): Call<ResponseBody>

/* å›ºå®šheaderçš„è¯·æ±‚ */
@Headers("user-agent:okhttp", "Cache-Control:max-age=0")
@GET("get_data.json")
fun getData(): Call<Data>

/* åŠ¨æ€headerçš„è¯·æ±‚ */
@Headers("user-agent:okhttp", "Cache-Control:max-age=0")
@GET("get_data.json")
fun getDataWithHeader(@Header("user-agent") userAgent: String,
                      @Header("Cache-Control") cacheControl: String): Call<Data>
```

### 11.6.3 Retrofitæ„å»ºå™¨çš„æœ€ä½³å†™æ³•

```kotlin
object ServiceCreator {

    private const val BASE_URL = "http://192.168.3.11/"
    private val retrofit = Retrofit.Builder()
        .baseUrl(BASE_URL)
        .addConverterFactory(GsonConverterFactory.create())
        .build()
    fun <T> create(serviceClass: Class<T>) = retrofit.create(serviceClass)
    inline fun <reified T> create(): T = create(T::class.java)
}
```

è°ƒç”¨ï¼š

```kotlin
fun main() {
    val appService = ServiceCreator.create<AppService>()
}
```



## 11.7 Kotlinè¯¾å ‚ï¼šä½¿ç”¨åç¨‹ç¼–å†™é«˜æ•ˆçš„å¹¶å‘ç¨‹åº

### 11.7.1 åç¨‹çš„åŸºæœ¬ç”¨æ³•

**å¼•å…¥ä¾èµ–**ï¼š

```
dependencies {
    ...
    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.1.1'
    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.1.1'
    ...
}
```

ç¬¬äºŒä¸ªæ˜¯åœ¨Androidé¡¹ç›®ä¸­ç”¨åˆ°çš„



> coroutineScopeå’ŒrunBlockingç±»ä¼¼ï¼Œä½†coroutineScopeåªä¼šé˜»å¡å½“å‰åç¨‹ï¼Œæ—¢ä¸å½±å“å…¶ä»–åç¨‹ï¼Œä¹Ÿä¸å½±å“ä»»ä½•çº¿ç¨‹ï¼Œå› æ­¤æ˜¯ä¸ä¼šé€ æˆä»»ä½•æ€§èƒ½ä¸Šçš„é—®é¢˜çš„

### 11.7.2 æ›´å¤šçš„ä½œç”¨åŸŸæ„å»ºå™¨

å¸¸ç”¨åˆ°çš„å†™æ³•ï¼š

```kotlin
/* å¸¸ç”¨çš„å†™æ³• */
val job = Job()
val scope = CoroutineScope(job)
scope.launch {
    // å¤„ç†é€»è¾‘1
}
scope.launch {
    // å¤„ç†é€»è¾‘2
}
job.cancel()
```

async å¸¸ç”¨åˆ°çš„å†™æ³•ï¼š

```kotlin
/* asyncçš„æ›´åˆç†ç”¨æ³• */
runBlocking {
    val start = System.currentTimeMillis()
    val deferred1 = async {
        delay(1000)
        5 + 5
    }
    val deferred2 = async {
        delay(1000)
        5 + 6
    }
    println("result is ${deferred1.await()} + ${deferred2.await()}")
    val end = System.currentTimeMillis()
    println(end - start)
}
```

`withContext`å¯ä»¥æŒ‡å®šåœ¨å“ªä¸­çº¿ç¨‹ä¸­å¼€å¯åç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹å¯åŠ¨ä¸‹è½½ä»»åŠ¡æ—¶ï¼Œå¯ä»¥è¿™æ ·åœ¨éä¸»çº¿ç¨‹åˆ›å»ºä¸‹è½½åç¨‹

```kotlin
suspend fun testWithContext() {
    val result = withContext(Dispatchers.Default) {
        5 + 5
    }
    println(result)
}
```

### 11.7.3 ä½¿ç”¨åç¨‹ç®€åŒ–å›è°ƒçš„å†™æ³•

å°è£…ï¼š

```kotlin
suspend fun <T> Call<T>.await(): T {
    return suspendCoroutine {
        enqueue(object : Callback<T> {
            override fun onFailure(call: Call<T>, t: Throwable) {
                t.printStackTrace()
            }

            override fun onResponse(call: Call<T>, response: Response<T>) {
                val body = response.body()
                if (body != null) it.resume(body)
                else it.resumeWithException(
                    RuntimeException("response body is null")
                )
            }
        })
    }
}
```

è¿™æ ·çš„å°è£…ï¼Œè™½ç„¶ä¸æ˜¯å®Œå…¨ç†è§£äº†ï¼Œä½†å†è°ƒç”¨å°±ç®€å•äº†ï¼š

```kotlin
suspend fun getAppData() {
    try {
        val appList =
            ServiceCreator.create<AppService>().getAppData().await()
        // å¯¹æœåŠ¡å™¨å“åº”çš„æ•°æ®è¿›è¡Œå¤„ç†
    } catch (e: Exception) {
        // å¼‚å¸¸å¤„ç†
    }
}
```

